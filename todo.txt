1. Работа с бизнес-логикой - Сделано
 + отображать сколько осталось ключу времени
 + корректно записывать в базу там почему-то на 5 часов меньше
 добавить логику продления ключа после истечения срока по запросу.
    +сделать кнопку в боте "продлить ключ"
    +при нажатии кнопки должен выполнятся функция по api панельки которая продлевает на месяц ключ
    +после api панельки, в БД должно обновиться время ключа
    (пока что без привязки к платежке, когда будет платежка сначала должна она обрабатываться потом этот код)

    POST https://57.129.67.153:65000/vpn-panel/panel/inbound/updateClient/6ffa6027-16c6-4ec0-8be9-6855915fd5be
    id: 2
    settings: {"clients": [{
      "id": "6ffa6027-16c6-4ec0-8be9-6855915fd5be",
      "flow": "xtls-rprx-vision",
      "email": "722c30yfp44nw",
      "limitIp": 0,
      "totalGB": 0,
      "expiryTime": 1744474296219,
      "enable": true,
      "tgId": "",
      "subId": "722c30yfp44nw",
      "comment": "",
      "reset": 0
    }]}

2. платежка крипта heleket
    нужно получить апи ключ, заявка отправлена
    1. создаю платеж POST https://api.heleket.com/v1/payment
    payload = {
    "amount": str,
    "currency": str,
    "order_id": str,
    }
    --------------------------------------------------
    [!]order_id должен быть уникальным в счетах продавца/статических кошельках/повторных платежах
    будет таблица в БД где будет хранится информация о счетах-фактурах, order_id будет равен id в этой таблице.

    orders
    - id
    - user_id ?
    - order_uuid
    - amount
    - status
    - expires_at - время которое дается на оплату счета, проверка будет учитывать это время
    - created_at
    - paid_at
    --------------------------------------------------
    Когда мы находим существующий счет-фактуру с order_id, мы возвращаем его реквизиты, новый счет-фактура создан не будет.

    создается заявка, хранится в БД заявка, со статусом
    проверяется каждые 30 секунд, если статус оплачен, то выдается ключ, в БД также меняется статус
    если статус не менятся то запись удаляется

    нужно создать объект order в БД раньше чем вызов функции create_invoice, потому что в функции передается order_id.
    Также нужно передавать туда amount.
    order создается, инвойс создается, дается ссылка юзеру. если юзер оплачивает
    ----------------------------------------------------
    НА РАССМОТРЕНИИ
    Возможно стоит сделать еще одну таблицу в БД под тарифы.
    в колбеке будет передаваться 1-2-3-4
    1 - это будет 1 тариф(1 месяц)
    2 - это будет 2 тариф(3 месяц)

    tariffs всего 8 записей
    ----------------------------------------------------
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    пришел к выводу что все это хуйня какая-то и лучше сделать на webhook-ах

    приходит инфа о ордере оттуда я беру айди и статус и меняю в таблице запись
    теперь я должен дать юзеру ключ после оплаты

    ---------------------------------------------------------------------------------------------
    + код для создания ключей в хэндлерах убирается, переносится в router.py
    + из service.models внутри функции убираю запросы для получения юзера, это должно быть приходить извне
    + убрать папку models из services, либо переименовать
    + нужно подумать над тем что если юзеру нужно продлить ключ. решение: там также оплата и мне просто нужно сделать проверку есть ли в БД уже ключ.
    + продумать логику тарифов:
        какую проблему нужно решить ?
        нужно решить проблему с формированием цены в зависимости от того что выбрал юзер
        можно использовать additional_data для хранения времени которую выбрал юзер
        можно в order добавить колонну с количеством дней. и все думаю так правильно

    - добавить кнопку для тестов, чтобы проходила оплата.

    ПОЛНОСТЬЮ СДЕЛАТЬ РЕВЬЮ


3. сделать секцию инструкции по подключению
4. поддержка

платежка откладывается, поэтому нужно решать насущные вопросы

5. Автоматизация поднятие серверов, панелей всей хуйни
https://chatgpt.com/share/68015397-8d34-8002-a412-787a4a97b3ce

я решил сделать докер контейнер в котором сначала устанавливается панелька 3x-ui
после я скриптом добавляю всякие сертификаты, inbound и все
нужно будет в БД хранить креды к серверам, точнее к доступам в панельке
----------------------------------------------------------------------------
нужно сохранять креды в БД
как выбирать креды из БД, можно также оставить выбор юзеру
по хорошему тогда сделать админку в которой можно управлять серверами, типо активно нет и все
----------------------------------------------------------------------------
в БД создать таблицу servers
id
server_ip
panel_port
panel_webpath
panel_username
panel_password
is_active
workload

----------------------------------------------------------------------------
22.04
актуальные задачи:
1. сделать юзера в пострес, доступом к инсерту и только одной таблице +++
открыть порт 433

2. админка в тг:
    что должен уметь ?
        возможность менять информацию о серверах
        возможность менять цены
добавить max_clients в servers
мб users

3. переписать логику бота, чтобы при покупке юзер выбирал сервер

++ при продлении ключа убрать выбор сервера.
++ чистить стейт
чекнуть почему происходит prepare_meth = resp.prepare


4. деплой бота + поменять вебхук на нгикс
ngrok http --url=dear-genuine-scorpion.ngrok-free.app 80

5. сделать другого юзера для БД 
 при создании vpn_key указать айди сервера
 убрать баг при обновлении ключа, чтобы не слетал flow

переделать utils.create_settings_for_new_key() в routes

server {
    listen 80;
    server_name 193.186.4.84;

    location / {
        proxy_pass http://unix:/run/gunicorn.sock;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}